#!/usr/bin/env zsh
#
# .zshenv - 環境変数設定ファイル
#
# このファイルはすべてのzshセッション（インタラクティブ・非インタラクティブ問わず）で
# 最初に読み込まれる。PATH、エディタ、ロケールなど基本的な環境変数を設定する。
#
# 読み込み順序: .zshenv → .zprofile → .zshrc → .zlogin
#

# ==============================================================================
# 基本設定の読み込み
# ==============================================================================

# dotfilesのパス設定を読み込み（$DOTPATH環境変数を設定）
source "$HOME/.path"

# 共通ユーティリティ関数を読み込み（get_os, logging等）
source "$DOTPATH/etc/lib.sh"

# ==============================================================================
# PATH配列の重複除去設定
# ==============================================================================
# typeset オプション:
#   -g: グローバルスコープで宣言（関数内でもローカルにならない）
#   -x: 環境変数としてエクスポート（子プロセスに継承）
#   -U: 配列の重複要素を自動的に除去（最初の出現のみ保持）
typeset -gx -U path cdpath fpath manpath

# ==============================================================================
# FPATH設定（zsh関数・補完関数の検索パス）
# ==============================================================================

# Homebrewのzsh関数パスを追加（補完機能等に必要）
prepend FPATH "$HOMEBREW_PREFIX/share/zsh/functions"
prepend FPATH "$HOMEBREW_PREFIX/share/zsh/site-functions"

# ==============================================================================
# autoload（遅延読み込み関数の登録）
# ==============================================================================
# autoload オプション:
#   -U: エイリアス展開を抑制（関数定義の安全性を確保）
#   -z: zsh形式で関数を読み込み

# run-help: ESC-h でカーソル位置のコマンドのヘルプを表示
autoload -Uz run-help

# add-zsh-hook: chpwd, precmd, preexec等のフック関数を簡単に登録
autoload -Uz add-zsh-hook

# colors: ANSIカラーコードを$fg, $bg等の連想配列で使用可能に
autoload -Uz colors && colors

# compinit: 補完システムの初期化（-u: 安全でないファイルの警告を抑制）
autoload -Uz compinit && compinit -u

# is-at-least: zshバージョン比較関数（バージョン依存の設定に使用）
autoload -Uz is-at-least

# ==============================================================================
# zsh基本設定
# ==============================================================================

# --- スペル修正 ---
# スペル修正候補から除外するパターン（アンダースコア始まりの内部関数等）
export CORRECT_IGNORE='_*'
export CORRECT_IGNORE_FILE='.*'

# --- ヒストリ設定 ---
# メモリ上に保持するヒストリ数
export HISTSIZE=10000
# ヒストリファイルのパス
export HISTFILE="$HOME/.zsh_history"
# ファイルに保存するヒストリ数（大きめに設定して履歴を多く残す）
export SAVEHIST=1000000

# セキュリティ: rootユーザーはヒストリを保存しない
if [[ $UID == 0 ]]; then
    unset HISTFILE
    export SAVEHIST=0
fi

# --- 補完表示 ---
# 補完候補をこの数以下なら確認なしで一覧表示
export LISTMAX=50

# --- 実行時間レポート ---
# この秒数以上かかったコマンドは実行時間を自動表示
export REPORTTIME=5

# ==============================================================================
# ロケール設定
# ==============================================================================

export LANGUAGE="ja_JP.UTF-8"
export LANG="$LANGUAGE"
export LC_ALL="$LANGUAGE"
export LC_CTYPE="$LANGUAGE"

# ==============================================================================
# エディタ設定
# ==============================================================================

# デフォルトエディタ（VS Codeを使用、--waitで編集完了を待機）
export EDITOR="code --wait"
export VISUAL="$EDITOR"
export SVN_EDITOR="$EDITOR"
export GIT_EDITOR="$EDITOR"

# ==============================================================================
# ページャー設定（less）
# ==============================================================================

export PAGER="less"

# lessのデフォルトオプション
#   -R (--RAW-CONTROL-CHARS): ANSIカラーエスケープを解釈して表示
#   -f (--force): 特殊ファイル（ディレクトリ等）も強制的に開く
#   -X (--no-init): 終了時に画面をクリアしない
#   -i (--ignore-case): 検索時に大文字小文字を区別しない
#   -M (--LONG-PROMPT): 詳細なプロンプトを表示
#   -W (--HILITE-UNREAD): スクロール後の新しい行をハイライト
#   -F (--quit-if-one-screen): 1画面に収まる場合は即終了
export LESS='-R -f -X -i -M -W -F'

# less用文字エンコーディング
export LESSCHARSET='utf-8'

# manページのカラー表示設定（LESS_TERMCAP_*）
export LESS_TERMCAP_mb=$'\E[01;31m'    # 点滅開始（赤太字）
export LESS_TERMCAP_md=$'\E[01;31m'    # 太字開始（赤太字）
export LESS_TERMCAP_me=$'\E[0m'        # 太字・点滅終了
export LESS_TERMCAP_se=$'\E[0m'        # 強調表示終了
export LESS_TERMCAP_so=$'\E[00;44;37m' # 強調表示開始（青背景白文字）
export LESS_TERMCAP_ue=$'\E[0m'        # 下線終了
export LESS_TERMCAP_us=$'\E[01;32m'    # 下線開始（緑太字）

# ==============================================================================
# lsコマンドのカラー設定
# ==============================================================================

# BSD ls用（macOS）: LSCOLORS
export LSCOLORS=exfxcxdxbxegedabagacad

# GNU ls用（Linux）: LS_COLORS
export LS_COLORS='di=34:ln=35:so=32:pi=33:ex=31:bd=46;34:cd=43;34:su=41;30:sg=46;30:tw=42;30:ow=43;30'

# ==============================================================================
# 言語環境設定
# ==============================================================================

# Go言語: GOPATHをホームディレクトリに設定
export GOPATH="$HOME"

# ==============================================================================
# PATH設定
# ==============================================================================
# (N-/): グロブ修飾子 - ディレクトリが存在しない場合は空文字に展開（エラー回避）

path=(
    "$GOPATH/bin"(N-/)          # Go binaries
    $path
)

manpath=(
    $manpath
)

# ==============================================================================
# OS固有の設定読み込み
# ==============================================================================

case "$(get_os)" in
    mac)
        [[ -f "$HOME/.zsh.d/mac.zshenv" ]] && source "$HOME/.zsh.d/mac.zshenv"
        ;;
esac
