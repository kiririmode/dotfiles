################################################################################
# 基本設定
################################################################################

# デフォルトシェルの設定
# 環境変数$SHELLを使用することで、システムに依存しない設定にする
set-option -g default-shell "$SHELL"
set-option -g default-command "$SHELL"

# Escapeキーの遅延を無効化
# Vimなどでモード切り替えが即座に反映されるようにする（デフォルト: 500ms）
set-option -s escape-time 0

# メッセージ表示時間（ミリ秒）
# ステータスラインのメッセージや画面上のインジケータの表示時間
set-option -g display-time 3500

# ペイン番号表示時間（ミリ秒）
# display-panesコマンドで表示されるペイン番号の表示時間
set-option -g display-panes-time 800

# ウィンドウ/ペインの開始番号を1にする
# 0始まりだとキーボード配置的に押しにくいため
set-option -g base-index 1
set-option -g pane-base-index 1

# ウィンドウを閉じた際に番号を振り直す
# 欠番が生じないようにする
set-option -g renumber-windows on

# スクロールバックバッファのサイズ（行数）
set-option -g history-limit 50000

# プレフィックスキーの連続入力許可時間（ミリ秒）
# この時間内はプレフィックスキーを再度押さなくてもコマンドを連続実行可能
set-option -sg repeat-time 600

# フォーカスイベントを有効化
# Vimのautoread等、フォーカス検知が必要な機能で使用
set-option -s focus-events on

# マウスサポートを有効化
# ペインの選択、リサイズ、スクロールをマウスで操作可能にする
set-option -g mouse on

# ウィンドウのアクティビティ通知
# バックグラウンドのウィンドウで出力があった場合にステータスラインでハイライト
set-option -g monitor-activity on
# アクティビティ発生時のメッセージ表示は無効化（ハイライトのみ）
set-option -g visual-activity off

# ウィンドウ名の自動リネームを有効化
set-window-option -g automatic-rename on

# ターミナルのタイトルを設定
set-option -g set-titles on

################################################################################
# プレフィックスキー設定
################################################################################

# プレフィックスキーをCtrl+tに変更
# デフォルトのCtrl+bは押しにくく、Ctrl+aはシェルの行頭移動と競合するため
set-option -g prefix C-t

# デフォルトのCtrl+bを解除
unbind-key C-b

# Ctrl+t を2回押すとアプリケーションにCtrl+tを送信
bind-key C-t send-prefix

################################################################################
# キーバインド - ウィンドウ/ペイン操作
################################################################################

# ペイン分割
# | : 水平分割（左右に分割）- 見た目が縦線なので直感的
# - : 垂直分割（上下に分割）- 見た目が横線なので直感的
bind-key | split-window -h -c "#{pane_current_path}"
bind-key - split-window -v -c "#{pane_current_path}"

# ペインを新しいウィンドウとして独立させる
bind-key b break-pane

# ペインを閉じる
bind-key q kill-pane

# ペイン番号を表示
bind-key i display-panes

# ペインのリサイズ（Vimライクなキーバインド）
# -r: repeat-time内なら連続入力可能
bind-key -r H resize-pane -L 2
bind-key -r J resize-pane -D 2
bind-key -r K resize-pane -U 2
bind-key -r L resize-pane -R 2

# ペイン間の移動（Vimライクなキーバインド）
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# ペインの入れ替え
# > : 現在のペインを次のペインと交換
# < : 現在のペインを前のペインと交換
bind-key > swap-pane -D
bind-key < swap-pane -U

################################################################################
# キーバインド - セッション操作
################################################################################

# セッションを終了
bind-key C-k kill-session

# セッション間の移動
# N: 次のセッション
# P: 前のセッション
bind-key N switch-client -n
bind-key P switch-client -p

################################################################################
# キーバインド - その他
################################################################################

# 設定ファイルをリロード
bind-key r source-file ~/.tmux.conf \; display "設定をリロードしました: ~/.tmux.conf"

# manページを新しいペインで表示
bind-key m command-prompt -p "Man:" "split-window -h 'man %%'"

# 現在のペインのパスを表示
bind-key C-p display-message "#{pane_current_path}"

################################################################################
# 外観設定 - 基本
################################################################################

# ステータスラインを上部に配置
set-option -g status-position top

# 256色ターミナルを使用
set-option -g default-terminal "screen-256color"

# True Color (24bit) サポートを有効化
# 対応ターミナル（iTerm2, Alacritty等）でフルカラー表示が可能になる
set-option -ga terminal-overrides ",xterm-256color:Tc"

################################################################################
# 外観設定 - ステータスライン
################################################################################

# ステータスラインの左右の最大長
set-option -g status-left-length 90
set-option -g status-right-length 90

# ステータスライン左側: セッション名とペイン番号
set-option -g status-left '#[fg=cyan,bold][#S:#P]#[default]'

# ステータスライン右側: 日時表示
# wifiやbatteryコマンドが必要な場合は追加可能
set-option -g status-right '#[fg=cyan][%Y-%m-%d(%a) %H:%M]#[default]'

# ステータスラインの更新間隔（秒）
set-option -g status-interval 1

# ウィンドウリストの配置を中央揃え
set-option -g status-justify centre

################################################################################
# 外観設定 - カラースキーム (Solarized Dark)
################################################################################

# ステータスラインの色
set-option -g status-style bg=colour235,fg=colour136

# ペイン境界線の色
# 非アクティブペイン
set-option -g pane-border-style fg=colour238
# アクティブペイン（目立つように青色）
set-option -g pane-active-border-style fg=colour39

# display-panesコマンドの番号色
set-option -g display-panes-active-colour colour33
set-option -g display-panes-colour colour166

# メッセージの色
set-option -g message-style fg=colour166,bg=colour235,bright

# 時計の色（prefix + t で表示）
set-window-option -g clock-mode-colour colour64

################################################################################
# コピーモード設定
################################################################################

# Viキーバインドを使用
set-option -g mode-keys vi

# コピーモードでのVimライクな操作
# v: 選択開始、y: コピー、Escape: キャンセル
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind-key -T copy-mode-vi Escape send-keys -X cancel

# クリップボード連携（OSに応じて設定）
# macOS: pbcopy を使用
# Linux: xclip または xsel を使用
if-shell "uname | grep -q Darwin" \
    "set-option -g default-command 'reattach-to-user-namespace -l $SHELL'" \
    ""

# macOSでのクリップボードコピー
if-shell "uname | grep -q Darwin" \
    "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'reattach-to-user-namespace pbcopy'" \
    ""

# Linuxでのクリップボードコピー（xclipがインストールされている場合）
if-shell "uname | grep -q Linux && which xclip > /dev/null 2>&1" \
    "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -selection clipboard'" \
    ""

################################################################################
# プラグイン設定
################################################################################

# TPM (Tmux Plugin Manager) によるプラグイン管理
#
# プラグイン操作:
#   prefix + I       : プラグインをインストール
#   prefix + U       : プラグインを更新
#   prefix + alt + u : プラグインをアンインストール
#
# TPMの初回インストール:
#   git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

set -g @tpm_plugins '              \
    tmux-plugins/tpm               \
    tmux-plugins/tmux-sensible     \
    tmux-plugins/tmux-cpu          \
    tmux-plugins/tmux-resurrect    \
    tmux-plugins/tmux-continuum    \
    tmux-plugins/tmux-logging      \
    seebi/tmux-colors-solarized    \
'

# tmux-resurrect: セッション保存/復元
# システム再起動後もtmux環境を復元可能
#   prefix + Ctrl+s : セッションを保存
#   prefix + Ctrl+r : セッションを復元
set-option -g @resurrect-save 'S'
set-option -g @resurrect-restore 'R'
# ペインの内容も復元
set-option -g @resurrect-capture-pane-contents 'on'

# tmux-continuum: セッションの自動保存
# 15分ごとに自動保存、tmux起動時に自動復元
set-option -g @continuum-restore 'on'
set-option -g @continuum-save-interval '15'

# tmux-logging: ペインのログ記録
# prefix + shift + p でログ記録を開始/停止
set-option -g @logging-path '~/log'

# TPMを起動（この行は必ず設定ファイルの最後に記述）
run-shell '~/.tmux/plugins/tpm/tpm'
